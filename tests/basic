#! /bin/sh
set -x
set -eu

TARGET="$( dirname "$0")/$( basename "$0").py"
# TODO: find these
PYTHON_VERSION="3.8" # Github actions ubuntu
PYTHON_MAJOR_MINOR_VERSION="310" # Windows on my laptop

REQUIREMENTS_FILE=$( mktemp --suffix=-requirements.txt )
VENV_DIR=$( mktemp -d --suffix=-venv )
trap 'rm -rf "$REQUIREMENTS_FILE" "$VENV_DIR" ' EXIT


UNAME_OPERATING_SYSTEM=$( uname --operating-system )
if [ "$UNAME_OPERATING_SYSTEM" = 'Msys' ]; then
    # TODO: find this
    PYTHON="C:/Users/jay/AppData/Local/Programs/Python/Python$PYTHON_MAJOR_MINOR_VERSION/python.exe"
elif [ "$UNAME_OPERATING_SYSTEM" = 'GNU/Linux' ]; then
    PYTHON="/usr/bin/python$PYTHON_VERSION"
else
    echo "Unknown operating system: $UNAME_OPERATING_SYSTEM"
    exit 1
fi

"$PYTHON" -m venv "$VENV_DIR"
# shellcheck source=/dev/null
. "$VENV_DIR/bin/activate"
PYTHON="$VENV_DIR/bin/python$PYTHON_VERSION"

grep '^## PWP_REQUIRE: .*$' "$TARGET" | cut -d' ' -f 3 >> "$REQUIREMENTS_FILE"
# "$PYTHON" -m pip upgrade pip --quiet
"$PYTHON" -m pip install --quiet --requirement "$REQUIREMENTS_FILE"

"$PYTHON" "$TARGET" "$@"
